#include <stdio.h>
#include <stdint.h>

// finds the start of the real transmission (where it becomes non-zero)
// we update the byte input[length] and restore it

uint8_t find_start_last_zero, find_start_first_data;
void find_start(uint8_t *input, uint8_t length) {
	uint8_t *start = input;
	uint8_t overwritten;

	overwritten = start[length];
	start[length] = 1;

	--input;
	while (*(++input) == 0)
		;

	start[length] = overwritten;
	find_start_first_data = input - start;

	if (find_start_first_data >= length || find_start_first_data == 0) {
		find_start_last_zero = find_start_first_data;
	}
	else {
		input = start + length;
		while (*(--input) != 0)
			;

		find_start_last_zero = input - start;
	}
}

// Calculates the [1,2,3,2,1] filter in place for triplets * 3
// many input samples, it looks 4 samples back into the input
// it also calculates the min and max filtered values

uint8_t filter3_min, filter3_max;
void filter3(uint8_t *input, uint16_t triplets) {
	uint8_t x0 = input[-3];
	uint8_t x1 = input[-2];
	uint8_t x2 = input[-1];

	uint8_t y0 = input[-4] + x0;
	uint8_t y1 = y0 + x1;
	uint8_t y2 = x0 + x1 + x2;

	uint8_t z = y0 + y1 + y2;

	uint8_t min = 255;
	uint8_t max = 0;

	do {
		z -= y0;
		y0 = y2 - x0;
		x0 = *input;
		y0 += x0;
		z += y0;
		*(input++) = z;

		if (z < min)
			min = z;
		if (z > max)
			max = z;

		z -= y1;
		y1 = y0 - x1;
		x1 = *input;
		y1 += x1;
		z += y1;
		*(input++) = z;

		if (z < min)
			min = z;
		if (z > max)
			max = z;

		z -= y2;
		y2 = y1 - x2;
		x2 = *input;
		y2 += x2;
		z += y2;
		*(input++) = z;

		if (z < min)
			min = z;
		if (z > max)
			max = z;
	} while (--triplets != 0);

	filter3_min = min;
	filter3_max = max;
}

// finds the positive zero corssings and stores them in a vector
// it overwrites input[length] and input[length+1] and restores them

int16_t zero_crossings[3];
void find_zero_crossings(uint8_t *input, uint16_t length, uint8_t low, uint8_t high) {
	uint8_t *start = input, *last;
	uint8_t over1, over2, count, a;
	int16_t pos1, pos2;

	over1 = start[length];
	over2 = start[length + 1];

	start[length] = low;
	start[length + 1] = high;

	--input;
	for (count = 0; count < 3; count++) {
		while (*(++input) > low)
			;

		last = input;

		for(;;) {
			a = *(++input);
			if (a <= low)
				last = input;
			else if (a >= high)
				break;
		}

		pos1 = last - start;
		if (pos1 == length)
			break;

		pos2 = input - start;

		zero_crossings[count] = (pos1 + pos2) >> 1;
	}

	start[length] = over1;
	start[length + 1] = over2;

	while (count < 3)
		zero_crossings[count++] = -1;
}

// --- testing

void test_find_start() {
	uint8_t input[11];
	uint8_t s,i;

	for (s = 0; s < 11; s++) {
		for (i = 0; i < 11; ++i)
			input[i] = 0;

		for (i = s; i < s + 5 && i < 10; ++i)
			input[i] = 1;

		find_start(input, 10);

		for (i = 0; i < 11; i++)
			printf("%u ", (unsigned int) input[i]);
		printf("- %u %u\n", (unsigned int) find_start_last_zero, (unsigned int) find_start_first_data);
	}
}

void test_filter3() {
	uint8_t input[16];
	uint8_t s,i;

	for (s = 0; s < 16; s++) {
		for (i = 0; i < 16; i++)
			input[i] = 0;
		input[s] = 1;
		filter3(input + 4, (16-4)/3);

		for (i = 0; i < 16; i++)
			printf("%u ", (unsigned int) input[i]);
		printf("- %u %u\n", (unsigned int) filter3_min, (unsigned int) filter3_max);
	}

}

// --- samples

// hatareset/01800_01007.raw
uint8_t samples1[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 12, 16, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 16, 16, 15, 15};

// hatareset/01870_01002.raw
uint8_t samples2[] = {1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 12, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 11, 10, 11, 10, 11, 11, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0};

// szep/01871_01007.raw
uint8_t samples3[] = {1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 15, 16, 16, 15, 14, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 14, 13, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 15, 14, 13, 13, 13, 14, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 14, 13, 13, 14, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 15, 14, 13, 13, 13, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 13, 13, 13, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 13, 13, 13, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 15, 15, 14, 13, 13, 13, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 13, 13, 13, 14, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 13, 13, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 14, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 14, 13, 13, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 13, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 14, 14, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 14, 13, 13, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 14, 13, 13, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 13, 13, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 14, 14, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 13, 13, 13, 14, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16, 15, 15, 14, 13, 13, 13, 14, 14, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15, 15, 15, 14, 13, 13, 13, 13, 14, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 16, 15};

// lassu/00145_01002.raw
uint8_t samples4[] = {1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 8, 8, 10, 11, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 11, 10, 9, 9, 10, 9, 9, 9, 10, 9, 10, 10, 10, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, 8, 8, 9, 8, 8, 8, 8, 7, 7, 7, 7, 7, 7, 6, 6, 5, 6, 5, 5, 4, 5, 5, 5, 5, 6, 5, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 7, 8, 8, 8, 9, 8, 8, 9, 8, 9, 8, 9, 9, 9, 9, 9, 9, 10, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 13, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 11, 11, 12, 12, 11, 11, 11, 11, 11, 12, 11, 12, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 9, 8, 9, 8, 8, 9, 7, 7, 7, 8, 7, 7, 7, 8, 7, 7, 7, 7, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 6, 5, 6, 6, 6, 7, 7, 7, 8, 7, 8, 8, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 9, 10, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 10, 11, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 11, 12, 11, 12, 12, 12, 11, 12, 12, 12, 12, 12, 12, 12, 12, 11, 11, 11, 10, 10, 10, 10};

void main() {
	test_find_start();
	// test_filter3();
}
